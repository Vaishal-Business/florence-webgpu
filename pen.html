<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR.js Rectangle + Pen Ink</title>
  <style>
    html,body{height:100%;margin:0;overflow:hidden;font-family:system-ui,Segoe UI,Roboto,Arial}
    #ui{position:fixed;left:8px;top:8px;z-index:30;display:flex;gap:8px;flex-wrap:wrap}
    button{padding:8px 12px;border-radius:6px;border:1px solid rgba(0,0,0,0.15);background:#fff}
    #overlayRect{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);border:2px dashed rgba(255,255,255,0.6);background:rgba(255,255,255,0.06);touch-action:none;z-index:20}
    .corner{width:18px;height:18px;background:#fff;border-radius:3px;position:absolute}
    .corner.tl{left:-9px;top:-9px;cursor:nwse-resize}
    .corner.tr{right:-9px;top:-9px;cursor:nesw-resize}
    .corner.bl{left:-9px;bottom:-9px;cursor:nesw-resize}
    .corner.br{right:-9px;bottom:-9px;cursor:nwse-resize}
    #hint{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);background:rgba(0,0,0,0.5);color:#fff;padding:6px 10px;border-radius:8px;z-index:40}
    canvas{position:fixed;inset:0;z-index:0}
  </style>
</head>
<body>
  <div id="ui">
    <button id="startAR">Start AR</button>
    <button id="applyRect">Apply (Lock Rectangle)</button>
    <button id="calibratePen">Calibrate Pen Tip</button>
    <button id="clearInk">Clear</button>
    <button id="saveInk">Save</button>
  </div>

  <div id="overlayRect" style="width:320px;height:180px;display:flex;align-items:center;justify-content:center;">
    <div class="corner tl"></div>
    <div class="corner tr"></div>
    <div class="corner bl"></div>
    <div class="corner br"></div>
  </div>

  <div id="hint">Placement mode: drag/move/resize rectangle. Press Apply to lock into world.</div>

  <!-- AR.js and three.js -->
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/three.js/build/three.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/three.js/build/ar-threex.js"></script>

  <script>
    let scene, camera, renderer;
    let arToolkitSource, arToolkitContext;
    let markerRoot;
    let overlay = document.getElementById('overlayRect');
    let applyBtn = document.getElementById('applyRect');
    let calibrateBtn = document.getElementById('calibratePen');
    let clearBtn = document.getElementById('clearInk');
    let saveBtn = document.getElementById('saveInk');
    let hint = document.getElementById('hint');

    let placementMode = true;
    let arPlane, inkCanvas, inkCtx;
    let penTipScreen = null;
    let penDownRequested = false;

    function init() {
      scene = new THREE.Scene();
      camera = new THREE.Camera();
      scene.add(camera);

      renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // ARToolkit Source
      arToolkitSource = new THREEx.ArToolkitSource({
        sourceType: 'webcam'
      });
      arToolkitSource.init(function onReady(){ onResize() });
      window.addEventListener('resize', ()=>{ onResize() });

      // ARToolkit Context
      arToolkitContext = new THREEx.ArToolkitContext({
        cameraParametersUrl: 'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/three.js/data/camera_para.dat',
        detectionMode: 'mono'
      });
      arToolkitContext.init(()=>{ camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix()); });

      // Marker Root
      markerRoot = new THREE.Group();
      scene.add(markerRoot);
      let markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
        type: 'pattern', patternUrl: 'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/three.js/data/patt.hiro'
      });

      // Create ink canvas and plane
      inkCanvas = document.createElement('canvas');
      inkCanvas.width = 1024; inkCanvas.height = 576;
      inkCtx = inkCanvas.getContext('2d');
      inkCtx.lineCap = 'round'; inkCtx.lineJoin = 'round'; inkCtx.lineWidth = 6; inkCtx.strokeStyle = '#000';
      inkCtx.fillStyle = 'rgba(255,255,255,0.0)'; inkCtx.fillRect(0,0,inkCanvas.width, inkCanvas.height);

      const tex = new THREE.CanvasTexture(inkCanvas);
      const geo = new THREE.PlaneGeometry(1.6, 0.9);
      const mat = new THREE.MeshBasicMaterial({map: tex, transparent:true, side:THREE.DoubleSide});
      arPlane = new THREE.Mesh(geo, mat);
      arPlane.position.y = 0.5;
      markerRoot.add(arPlane);

      animate();
    }

    function onResize(){
      arToolkitSource.onResize(); arToolkitSource.copySizeTo(renderer.domElement);
      if (arToolkitContext.arController!==null){ arToolkitSource.copySizeTo(arToolkitContext.arController.canvas); }
    }

    function animate(){
      requestAnimationFrame(animate);
      if (arToolkitSource.ready) arToolkitContext.update(arToolkitSource.domElement);
      renderer.render(scene, camera);
      arPlane.material.map.needsUpdate = true;

      // Simple pen draw simulation
      if (penTipScreen && penDownRequested){ drawDot(penTipScreen.x, penTipScreen.y); }
    }

    let lastPenPos = null;
    function drawDot(x,y){
      const cx = x/ window.innerWidth * inkCanvas.width;
      const cy = y/ window.innerHeight * inkCanvas.height;
      if (!lastPenPos){ lastPenPos={x:cx,y:cy}; }
      inkCtx.beginPath(); inkCtx.moveTo(lastPenPos.x, lastPenPos.y); inkCtx.lineTo(cx,cy); inkCtx.stroke(); inkCtx.closePath();
      lastPenPos={x:cx,y:cy};
    }

    applyBtn.onclick = ()=>{ overlay.style.display='none'; placementMode=false; hint.innerText='Rectangle locked. Draw on the marker plane.'; };
    clearBtn.onclick = ()=>{ inkCtx.clearRect(0,0,inkCanvas.width,inkCanvas.height); };
    saveBtn.onclick = ()=>{ const url=inkCanvas.toDataURL('image/png'); const a=document.createElement('a');a.href=url;a.download='ar-board.png';a.click(); };

    document.getElementById('startAR').onclick=()=>{ init(); };
  </script>
</body>
</html>
